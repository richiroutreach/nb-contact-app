<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="msapplication-tap-highlight" content="no" />
		<title>NationBuilder Contacts</title>

		<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

		<link rel="stylesheet" href="css/foundation.min.css" />
		<link rel="stylesheet" href="css/app.css" />

		<script src="js/vendor/modernizr.js"></script>
	</head>

	<body>
		<div id="log-in-box" class="row">
			<div class="large-12 columns">
				<div class="logo">
					<img src="img/nb-logo.png" />
				</div>

				<h1>Contacts</h1>

				<div>
					<input name="slug" id="slug" type="text" placeholder="Nation Slug"/>
				</div>

				<input class="button wide large" type="button" id="logIn" value="Log In" />
			</div>
		</div> <!-- #log-in-box -->

		<div id="main-menu" class="row hidden">
			<div class="large-12 columns">
				<a id="search-button">
					<i class="fa fa-search fa-fw"></i>
					<span>Search Contacts</span>
				</a>
			</div>

			<div class="large-12 columns">
				<a id="create-button">
					<i class="fa fa-plus fa-fw"></i>
					<span>Add Contact</span>
				</a>
			</div>
		</div> <!-- #main-menu -->

		<div class="hidden">
			<input class="button large" type="button" id="showToken" value="Show Token" />
			<input class="button large" type="button" id="showIndex" value="Index" />
			<input class="button large" type="button" id="matchEmail" value="Lookup Nicole" />
			<input class="button large" type="button" id="searchFunction" value="Search" />
			<input class="button large" type="button" id="testPush" value="Push" />
		</div>

		<div id="output"></div>
	</body>

	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

	<script>
		$('#logIn').click(function() {
			$.getJSON('http://contacts.richiroutreach.com/api-endpoint.php', { slug: $( '#slug' ).val(), endpoint: 'code' }, function( response ) {
				checkAuthentication();

				if( response.result.code == 2 ) {
					var ref = window.open( response.result.redirect_url, "_blank" );		
				}
			});
		});

		$('#showToken').click(function() {
			$.getJSON('http://contacts.richiroutreach.com/api-endpoint.php', { slug: 'richir', endpoint: 'authorized' }, function( response ) {
				if( response.code == 5 ) {
					$( '#output' ).append( 'Authorized!' );
				} else {
					$( '#output' ).append( 'Not Authorized' );
				}
			});
		});

		$('#matchEmail').click(function() {
			$.getJSON('http://contacts.richiroutreach.com/api-endpoint.php', { slug: 'richir', endpoint: 'people', method: 'match', params: { email: 'nicole@richiroutreach.com' } }, function( response ) {
				$( '#output' ).html(response );
			});
		});

		$('#testPush').click(function() {
			$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: 'richir', endpoint: 'people', method: 'push', params: { person: { email: "nicole@richiroutreach.com", will_vote: "no" } } }, function(response) {
				$( '#output' ).html(response );
			});
		});

		$('#searchFunction').click(function() {
			$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: 'richir', endpoint: 'people', method: 'search', params: { custom_values: { will_vote: "yes" } } }, function(response) {
				$( '#output' ).html(response );
			});
		});

		$('#showIndex').click(function() {
			$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: 'richir', endpoint: 'people', method: 'index' }, function(response) {
				$( '#output' ).append( '<h1>' + response.result.code + '</h1>' );
			});
		});

		function checkAuthentication() {
			setTimeout(function() {
				$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: $( '#slug' ).val(), endpoint: 'authorized' }, function( response ) {
					if( response.code == "5" ) {
						$( document ).trigger( 'authenticated' );
						clearTimeout();
					} else {
						checkAuthentication();
					}
				});
			}, 1000);			
		}

		$(document).on("authenticated", function() {
			$( '#log-in-box' ).fadeOut( 300 );

			$( '#main-menu').fadeIn( 300 );

//			$( '#loading-modal' ).foundation('reveal', 'open');

			loadData();
		});		

		function loadData() {
			$.when(
				$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: $( '#slug' ).val(), endpoint: 'nation', method: 'contact_types' }, function( response ) {
/*
					for( i = 0; i < response.result.results.length; i++ ) {
						types[ response.result.results[i].id ] = response.result.results[i].name;

						$( '#select-type' ).append('<option value="' + response.result.results[i].id + '">' + response.result.results[i].name + '</option>')
					}
*/
				}),

				$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: $( '#slug' ).val(), endpoint: 'nation', method: 'contact_methods' }, function( response ) {
/*
					for( i = 0; i < response.result.results.length; i++ ) {
						methods[ response.result.results[i].api_name ] = response.result.results[i].name;

						$( '#select-method' ).append('<option value="' + response.result.results[i].api_name + '">' + response.result.results[i].name + '</option>')
					}
*/
				}),		

				$.getJSON( 'http://contacts.richiroutreach.com/api-endpoint.php', { slug: $( '#slug' ).val(), endpoint: 'nation', method: 'contact_statuses' }, function( response ) {
/*
					for( i = 0; i < response.result.results.length; i++ ) {
						statuses[ response.result.results[i].api_name ] = response.result.results[i].name;

						$( '#select-status' ).append('<option value="' + response.result.results[i].api_name + '">' + response.result.results[i].name + '</option>')
					}
*/
				}),
			).done(function() {
//				$( '#loading-modal' ).foundation('reveal', 'close');
				$( '#main-menu' ).fadeIn( 300 );
			});
		}
	</script>

	<!-- Required for Phone Gap -->
	<script type="text/javascript" src="cordova.js"></script>

	<script type="text/javascript">
		// Initialize PhoneGap
		app.initialize();
	</script>

	<!-- Foundation JS -->
	<script src="js/foundation.min.js"></script>

	<script>
		// Initialize Foundation
		$(document).foundation();
	</script>
</html>
